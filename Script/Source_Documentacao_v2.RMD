---
title: "Prevendo Demandas de Estoque com Base em Vendas"
author: "Luiz Fernando Mello"
date: "29/06/2021"
output: html_document
---

# Preparando os dados para Análise Exploratória

## Setar local de trabalho
```{r}
setwd("C:/repos/Projeto02_PrevendoDemandaDeEstoqueComBaseEmVendas/Script_v2")
```

## Carregar bibliotecas
```{r results='hide'}
library(data.table)
library(dplyr)
library(ggplot2)
library(corrplot)
```

## Carregar o dataset
```{r}
dados <- fread("../Datasets/train.csv", header = TRUE, sep = ",",
               encoding = "UTF-8")
```

## Split no dataset
```{r}
set.seed(357123)
indexSplit <- sample.int(nrow(dados), 200000)
vendas <- dados[indexSplit,]
```

## Remover variáveis que não vão ser utilizadas
```{r}
rm(dados, indexSplit)
```

## Visualizar os dados
```{r}
str(vendas)
```

## Verificar se existe valores NA
```{r}
any(is.na(vendas))
```

## Renomear as variáveis do dataset
```{r}
novosNomes <- c("Semana", "Agencia_ID", "Canal_ID",
                "Rota_ID", "Cliente_ID", "Produto_ID",
                "Unidade_Vendida", "Peso_Vendido", "Unidade_Devolucao",
                "Peso_Devolucao", "Demanda_Estoque")
colnames(vendas) <- novosNomes
```

## Alterar tipo de dado das variáveis categóricas
```{r}
var.categoricas <- c("Semana", "Agencia_ID", "Canal_ID",
                     "Rota_ID", "Cliente_ID", "Produto_ID")

for(i in var.categoricas) {
  vendas[[i]] <- as.factor(vendas[[i]])
}
```

## Declarando vetor com variáveis numéricas
```{r}
var.numericas <- c(character(0))
for(i in colnames(vendas)) {
  if(is.numeric(vendas[[i]])) {
    var.numericas <- append(var.numericas, i)
  }
}
```


# Análise Exploratória das variáveis numéricas

## Medidas de tendência central
```{r}
for(i in var.numericas) {
  print(paste("Medidas de tendencia central da variável", i))
  print(summary(vendas[[i]]))
  cat("\n")
}
```

## Medidas de dispersão
```{r}
for(i in var.numericas) {
  print(paste("Medidas de dispersão da variável", i))
  print(paste("Variância:", round(var(vendas[[i]]), 2)))
  print(paste("Desvio padrão:", round(sd(vendas[[i]]), 2)))
  cat("\n")
}
```

## Histogramas
```{r}
for(i in var.numericas) {
  hist(vendas[[i]],
       main = paste("Histograma da variável", i),
       xlab = i)
}
```

##### Conclusão: Analisando as frequencias, as variáveis não estão em uma distribuição normal parece que temos muitos outliers, vamos verificar melhor com boxplot.

## Boxplots
```{r}
for(i in var.numericas) {
  boxplot(vendas[[i]],
       main = paste("Boxplot da variável", i),
       xlab = i)
}
```

##### Conclusão: Muitos outliers em nossas variáveis.

## Análise de correlação (Plot de correlação das variáveis)
```{r}
corrplot(cor(select(vendas, var.numericas)), method = "color")
```
##### Conclusão: As variáveis que tem mais correlação com a variavel target (Demanda_Estoque) é Unidade_Vendida e Peso_Vendido


# Análisando os dados por semana

## Preparando os dados para realizar a análise
```{r}
vendas_semana <- vendas %>%
  group_by(Semana) %>%
  summarise(Unidade_Devolucao = sum(Unidade_Devolucao),
            Unidade_Vendida = sum(Unidade_Vendida),
            Peso_Vendido = sum(Peso_Vendido),
            Peso_Devolucao = sum(Peso_Devolucao),
            Demanda_Estoque = sum(Demanda_Estoque))
```

## Tabela de dados sumarizados por semana
```{r}
print(vendas_semana)
```

## Gráfico de cada variável numérica por semana
```{r}
for(i in var.numericas) {
    plot(ggplot(vendas_semana, aes(x = as.integer(Semana), y = .data[[i]])) +
      geom_line() +
      geom_point(color = "red") +
      ggtitle(paste(i, "por Semana")) +
      xlab("Semana"))
}
```

##### Conclusão: 
##### A semana com mais Unidades vendidas é a semana 4
##### A semana com mais Pesos vendidos é a semana 8
##### A semana com mais Unidades devolvidas é a semana 7
##### A semana com mais Pesos devolvidos é a semana 7
##### A semana com mais Demanda de estoque é a semana 4
##### A semana 4 teve mais produtos vendidos que as demais e uma das que menos teve devoluções.


# Análisando os dados por produto

## Preparando os dados para realizar a análise
```{r}
vendas_produto <- vendas %>%
  select(Produto_ID, Unidade_Vendida, Peso_Vendido,
         Unidade_Devolucao, Peso_Devolucao, Demanda_Estoque) %>%
  group_by(Produto_ID) %>%
  summarise(Unidade_Vendida = sum(Unidade_Vendida), 
            Peso_Vendido = sum(Peso_Vendido),
            Unidade_Devolucao = sum(Unidade_Devolucao), 
            Peso_Devolucao = sum(Peso_Devolucao), 
            Demanda_Estoque = sum(Demanda_Estoque))
```

## Tabela de dados sumarizados por produto
```{r}
print(vendas_produto)
```

## Gráfico de cada variável numérica por produto
```{r}
for(i in var.numericas) {
  # Ordenar o dataframe em ordem decrescente com a variável que está sendo 
  # iterada e pegar os 10 primeiros
  plot(ggplot(top_n(vendas_produto[order(-vendas_produto[[i]]),], 10),
         aes(Produto_ID, .data[[i]])) +
    geom_bar(stat = "identity") +
    ggtitle(paste("Top 10 produtos com mais", i)))
}
```

##### Conclusão:
##### Produto 2425 com mais unidades vendidas
##### Produto 2233 com mais peso vendido
##### Produto 36610 com mais unidades devolvidas
##### Produto 2233 com mais peso devolvido
##### Produto 2425 com mais demanda de estoque
##### Podemos concluir que o produto 2425 é o mais vendido, o produto 2233 é produto que é mais vendido por peso, porém é o mais devolvido tambem e o produto 36610 é o que tem mais unidades devolvidas e um dos menos vendidos.


# Análisando os dados por cliente

## Preparando os dados para realizar a análise
```{r}
vendas_cliente <- vendas %>%
  select(Cliente_ID, Unidade_Vendida, Peso_Vendido,
         Unidade_Devolucao, Peso_Devolucao, Demanda_Estoque) %>%
  group_by(Cliente_ID) %>%
  summarise(Unidade_Vendida = sum(Unidade_Vendida), 
            Peso_Vendido = sum(Peso_Vendido),
            Unidade_Devolucao = sum(Unidade_Devolucao), 
            Peso_Devolucao = sum(Peso_Devolucao), 
            Demanda_Estoque = sum(Demanda_Estoque))
```

## Tabela de dados sumarizados por cliente
```{r}
print(vendas_cliente)
```

## Gráfico de cada variável numérica por cliente
```{r}
for(i in var.numericas) {
  # Ordenar o dataframe em ordem decrescente com a variável que está sendo 
  # iterada e pegar os 10 primeiros
  plot(ggplot(top_n(vendas_cliente[order(-vendas_cliente[[i]]),], 10),
              aes(Cliente_ID, .data[[i]])) +
         geom_bar(stat = "identity") +
         ggtitle(paste("Top 10 clientes com mais", i)))
}
```

##### Conclusão: 653378 é o cliente que mais comprou e devolveu produtos.